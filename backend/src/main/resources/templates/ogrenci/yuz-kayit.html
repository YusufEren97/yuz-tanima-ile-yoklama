<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yüz Kaydı - Yoklama Sistemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        #video {
            max-width: 500px !important;
        }

        @media (max-width: 768px) {
            #video {
                max-width: 400px !important;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a th:href="@{/ogrenci}"><i class="fas fa-graduation-cap"></i> Adıyaman Üniversitesi</a>
            </div>
            <div class="nav-links">
                <a th:href="@{/ogrenci}"><i class="fas fa-home"></i> Ana Sayfa</a>
                <a th:href="@{/ogrenci/yuz-kayit}" class="active"><i class="fas fa-camera"></i> Yüz Kaydı</a>
                <a th:href="@{/profil}"><i class="fas fa-user"></i> Profil</a>
                <a th:href="@{/cikis}" class="desktop-only btn-logout"><i class="fas fa-sign-out-alt"></i> Çıkış</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-id-badge"></i> Yüz Kayıt İşlemi</h1>
            <p>Sisteme giriş yapabilmek için yüzünüze ait 5 adet fotoğrafı kaydetmelisiniz.</p>
        </div>

        <div th:if="${mesaj} or ${param.basarili}" class="mb-4 text-success"
            style="background: var(--success-bg); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--success);">
            <i class="fas fa-check-circle"></i> <span
                th:text="${mesaj != null ? mesaj : 'İşlem başarıyla tamamlandı!'}"></span>
        </div>
        <div th:if="${hata}" class="mb-4 text-danger"
            style="background: var(--danger-bg); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--danger);">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${hata}"></span>
        </div>

        <div class="card">
            <div th:if="${yuzKayitli}" class="text-center" id="registeredView">
                <div style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Yüzünüz Sisteme Kayıtlı</h2>
                <p class="mb-4">Yüz tanıma ile yoklamalara katılabilirsiniz.</p>

                <div class="d-flex justify-center gap-2" style="justify-content: center;">
                    <button type="button" class="btn btn-primary" onclick="showCamera()">
                        <i class="fas fa-camera-rotate"></i> Fotoğrafları Güncelle
                    </button>

                    <form th:action="@{/ogrenci/yuz-sil}" method="post"
                        onsubmit="return confirm('Yüz veriniz sistemden tamamen silinecek. Emin misiniz?');">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Kaydı Sil (Sıfırla)
                        </button>
                    </form>
                </div>
            </div>

            <div id="cameraSection" th:style="${yuzKayitli} ? 'display:none;' : ''">
                <div class="camera-container">
                    <div class="camera-view" style="position: relative;">
                        <video id="video" autoplay playsinline
                            style="width: 100%; max-width: 400px; margin: 0 auto; border-radius: var(--radius); display: block; transform: scaleX(-1);"></video>
                        <div id="poseInstruction" class="pose-instruction">DÜZ BAKIN</div>
                    </div>

                    <div class="photo-grid mt-3" id="photoGrid" style="max-width: 500px; margin: 0.75rem auto;">
                        <!-- Javascript populates this -->
                        <div class="photo-placeholder"><i class="fas fa-image"></i></div>
                        <div class="photo-placeholder"><i class="fas fa-image"></i></div>
                        <div class="photo-placeholder"><i class="fas fa-image"></i></div>
                        <div class="photo-placeholder"><i class="fas fa-image"></i></div>
                        <div class="photo-placeholder"><i class="fas fa-image"></i></div>
                    </div>

                    <div class="d-flex justify-between mt-3 gap-2">
                        <button type="button" id="captureBtn" class="btn btn-primary flex-fill">
                            <i class="fas fa-camera"></i> Fotoğraf Çek (<span id="photoCount">0</span>/5)
                        </button>
                        <button type="button" id="resetBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-redo"></i> Sıfırla
                        </button>
                    </div>

                    <form id="uploadForm" th:action="@{${yuzKayitli} ? '/ogrenci/yuz-guncelle' : '/ogrenci/yuz-kayit'}"
                        method="post" enctype="multipart/form-data">
                        <input type="file" name="fotograflar" id="photoInput" multiple accept="image/*"
                            style="display:none;">
                        <button type="submit" id="saveBtn" class="btn btn-success btn-block mt-3" disabled>
                            <i class="fas fa-save"></i> <span
                                th:text="${yuzKayitli ? 'Güncelle ve Kaydet' : 'Kaydı Tamamla'}"></span>
                        </button>
                    </form>
                </div>

                <div class="mt-4" style="background: var(--primary-soft); padding: 1rem; border-radius: var(--radius);">
                    <h3 class="text-primary mb-2" style="font-size: 1.1rem;"><i class="fas fa-info-circle"></i>
                        Talimatlar</h3>
                    <ul style="font-size: 0.95rem; margin-left: 1.5rem; list-style-type: disc;">
                        <li>Kamera izinlerine onay verin.</li>
                        <li>Yüzünüzün net göründüğünden emin olun.</li>
                        <li>Sırasıyla: <strong>Düz, Sağa, Sola, Yukarı ve Aşağı</strong> bakarak 5 fotoğraf çekin.</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2026 Adıyaman Üniversitesi - Yüz Tanıma Sistemi</p>
        </div>
    </footer>

    <script th:inline="javascript">
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const resetBtn = document.getElementById('resetBtn');
        const saveBtn = document.getElementById('saveBtn');
        const photoGrid = document.getElementById('photoGrid');
        const photoCount = document.getElementById('photoCount');
        const uploadForm = document.getElementById('uploadForm');
        const photoInput = document.getElementById('photoInput');
        const poseInstruction = document.getElementById('poseInstruction');

        const poseInstructions = ['DÜZ BAKIN', 'SAĞA BAKIN', 'SOLA BAKIN', 'YUKARI BAKIN', 'AŞAĞI BAKIN'];
        let photos = [];
        let stream = null;

        async function startCamera() {
            try {
                if (stream) stream.getTracks().forEach(t => t.stop());
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 } });
                video.srcObject = stream;
                showPoseInstruction();
            } catch (err) { alert('Kamera hatası: ' + err.message); }
        }

        window.showCamera = function () {
            const rv = document.getElementById('registeredView');
            if (rv) rv.style.display = 'none';
            document.getElementById('cameraSection').style.display = 'block';
            startCamera();
        }

        function showPoseInstruction() {
            if (photos.length < 5) {
                poseInstruction.textContent = poseInstructions[photos.length];
                poseInstruction.classList.add('show');
                poseInstruction.style.display = 'block';
            } else {
                poseInstruction.style.display = 'none';
            }
        }

        function updateUI() {
            photoCount.textContent = photos.length;
            photoGrid.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                if (photos[i]) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(photos[i]);
                    // Styles are now handled by class, but keep basic overrides just in case
                    img.style.width = '100%'; img.style.height = '100%'; img.style.borderRadius = '8px'; img.style.objectFit = 'cover';
                    photoGrid.appendChild(img);
                } else {
                    const div = document.createElement('div');
                    div.className = 'photo-placeholder';
                    div.innerHTML = '<i class="fas fa-image"></i>';
                    photoGrid.appendChild(div);
                }
            }
            resetBtn.disabled = photos.length === 0;
            saveBtn.disabled = photos.length < 5;
            captureBtn.disabled = photos.length >= 5;
        }

        captureBtn.addEventListener('click', () => {
            if (photos.length >= 5) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(blob => {
                photos.push(blob);
                updateUI();
                showPoseInstruction();
            }, 'image/jpeg', 0.9);
        });

        resetBtn.addEventListener('click', () => {
            photos = [];
            updateUI();
            showPoseInstruction();
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (photos.length < 5) {
                alert('Lütfen 5 fotoğraf çekin.'); return;
            }

            // Butonu yükleniyor durumuna getir
            saveBtn.disabled = true;
            const originalBtnContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';

            const formData = new FormData();
            photos.forEach((p, i) => formData.append('fotograflar', p, `photo_${i}.jpg`));

            try {
                const response = await fetch(uploadForm.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok || response.redirected) {
                    // Başarılı
                    window.location.href = '/ogrenci/yuz-kayit?basarili=true';
                } else {
                    // Hata durumunu yönet
                    let errorMessage = 'Kayıt sırasında bir hata oluştu.';
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.mesaj) {
                            errorMessage = errorData.mesaj;
                        } else if (typeof errorData === 'string') {
                            errorMessage = errorData;
                        }
                    } catch (jsonErr) {
                        try {
                            const text = await response.text();
                            if (text) errorMessage = text;
                        } catch (textErr) { console.error(textErr); }
                    }

                    // Mesajları temizle
                    if (errorMessage.includes('yuz bulunamadi') || errorMessage.includes('No face detected')) {
                        errorMessage = 'Fotoğrafların bazılarında yüz algılanamadı. Işık alan bir yerde, yüzünüz net görünecek şekilde tekrar deneyin.';
                    } else if (errorMessage.includes('coklu yuz')) {
                        errorMessage = 'Birden fazla yüz algılandı. Lütfen sadece kendi yüzünüzün göründüğünden emin olun.';
                    } else if (errorMessage.includes('eslesmedi')) {
                        errorMessage = 'Yüz verileri doğrulanamadı. Lütfen adımları takip ederek dikkatlice tekrar çekim yapın.';
                    }

                    throw new Error(errorMessage);
                }

            } catch (err) {
                // Teknik detayları temizle
                let cleanMsg = err.message;
                if (cleanMsg.includes('{') || cleanMsg.includes('400') || cleanMsg.includes('BAD REQUEST')) {
                    cleanMsg = 'Kayıt işlemi başarısız oldu. Lütfen internet bağlantınızı kontrol edip tekrar deneyin.';
                } else if (cleanMsg.includes('<html') || cleanMsg.includes('<!DOCTYPE')) {
                    cleanMsg = 'Sunucu ile iletişimde bir sorun oluştu. Lütfen daha sonra tekrar deneyin.';
                }

                alert(cleanMsg);

                // Butonu eski haline getir
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnContent;
            }
        });

        /*<![CDATA[*/
        const isRegistered = /*[[${yuzKayitli}]]*/ false;
        if (!isRegistered) startCamera();
        /*]]>*/
    </script>
</body>

</html>