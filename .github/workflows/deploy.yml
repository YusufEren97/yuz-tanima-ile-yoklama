name: Deploy to AWS EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Manuel tetikleme iÃ§in

env:
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.12'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Kodu Ã§ek
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Java 17 kur
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # 3. application-prod.properties dosyasÄ±nÄ± secrets ile oluÅŸtur
      - name: Create production properties
        run: |
          cat > backend/src/main/resources/application-prod.properties << EOF
          # Sunucu Ayarlari
          server.port=8080

          # MySQL Veritabani (Production)
          spring.datasource.url=jdbc:mysql://${{ secrets.DB_HOST }}:3306/${{ secrets.DB_NAME }}?useSSL=false&serverTimezone=Europe/Istanbul&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
          spring.datasource.username=${{ secrets.DB_USERNAME }}
          spring.datasource.password=${{ secrets.DB_PASSWORD }}
          spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

          # JPA / Hibernate
          spring.jpa.hibernate.ddl-auto=update
          spring.jpa.show-sql=false
          spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
          spring.jpa.properties.hibernate.format_sql=false

          # Thymeleaf
          spring.thymeleaf.cache=true

          # Session
          server.servlet.session.timeout=120m

          # Python Yuz Tanima Servisi
          face.service.url=http://localhost:5000

          # Yukleme Limitleri
          spring.servlet.multipart.max-file-size=10MB
          spring.servlet.multipart.max-request-size=50MB
          EOF

      # 4. Maven ile build
      - name: Build with Maven
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests -q
          
      # 5. Build artifact kontrolÃ¼
      - name: Verify JAR file
        run: |
          if [ -f "backend/target/yoklama-1.0.0.jar" ]; then
            echo "âœ… JAR file created successfully"
            ls -la backend/target/yoklama-1.0.0.jar
          else
            echo "âŒ JAR file not found!"
            ls -la backend/target/
            exit 1
          fi

      # 6. Python servisini paketle
      - name: Package Python service
        run: |
          cd python-yuz-servisi
          tar -czvf ../python-service.tar.gz .
          echo "âœ… Python service packaged"

      # 7. SSH key ayarla
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # 8. EC2'nin eriÅŸilebilir olduÄŸunu kontrol et
      - name: Check EC2 connectivity
        run: |
          echo "Testing SSH connection to EC2..."
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} \
            "echo 'âœ… SSH connection successful'"

      # 9. Servisleri durdur
      - name: Stop services on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          echo "Stopping services..."
          sudo systemctl stop yoklama-backend 2>/dev/null || echo "Backend service not running"
          sudo systemctl stop yoklama-python 2>/dev/null || echo "Python service not running"
          echo "âœ… Services stopped"
          EOF

      # 10. JAR dosyasÄ±nÄ± EC2'ye kopyala
      - name: Deploy JAR to EC2
        run: |
          echo "Uploading JAR file..."
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            backend/target/yoklama-1.0.0.jar \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:/opt/yoklama-sistemi/backend/
          echo "âœ… JAR file uploaded"

      # 11. Python servisini EC2'ye kopyala
      - name: Deploy Python service to EC2
        run: |
          echo "Uploading Python service..."
          scp -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            python-service.tar.gz \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          echo "Extracting Python service..."
          cd /opt/yoklama-sistemi/python-yuz-servisi
          # yuz_verileri klasÃ¶rÃ¼nÃ¼ koru (mevcut yÃ¼z verilerini silme)
          if [ -d "yuz_verileri" ]; then
            mv yuz_verileri /tmp/yuz_verileri_backup
          fi
          tar -xzf /tmp/python-service.tar.gz
          if [ -d "/tmp/yuz_verileri_backup" ]; then
            rm -rf yuz_verileri
            mv /tmp/yuz_verileri_backup yuz_verileri
          fi
          mkdir -p yuz_verileri
          rm /tmp/python-service.tar.gz
          echo "âœ… Python service extracted"
          EOF

      # 12. Python baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± gÃ¼ncelle
      - name: Update Python dependencies
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          echo "Updating Python dependencies..."
          cd /opt/yoklama-sistemi/python-yuz-servisi
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          echo "âœ… Python dependencies updated"
          EOF

      # 13. Servisleri baÅŸlat
      - name: Start services on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          echo "Starting services..."
          sudo systemctl start yoklama-python
          sleep 5
          sudo systemctl start yoklama-backend
          echo "âœ… Services started"
          
          # Servis durumlarÄ±nÄ± kontrol et
          echo ""
          echo "=== Service Status ==="
          echo "Python service:"
          sudo systemctl is-active yoklama-python
          echo "Backend service:"
          sudo systemctl is-active yoklama-backend
          EOF

      # 14. Health check
      - name: Health check
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          echo "Checking Python service (port 5000)..."
          curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/ || echo "Python service check"
          
          echo "Checking Backend service (port 8080)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "302" ]; then
            echo "âœ… Backend is responding (HTTP $response)"
          else
            echo "âš ï¸ Backend returned HTTP $response (may still be starting)"
          fi
          EOF

      # 15. Temizlik
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/ec2_key.pem
          rm -f python-service.tar.gz
          echo "âœ… Cleanup completed"

      # 16. Deployment Ã¶zeti
      - name: Deployment summary
        run: |
          echo "========================================="
          echo "       DEPLOYMENT COMPLETED!"
          echo "========================================="
          echo ""
          echo "ðŸŒ Application URL: http://${{ secrets.AWS_EC2_HOST }}:8080"
          echo "ðŸ Python API URL:  http://${{ secrets.AWS_EC2_HOST }}:5000"
          echo ""
          echo "ðŸ“‹ To check logs, SSH into EC2 and run:"
          echo "   sudo journalctl -u yoklama-backend -f"
          echo "   sudo journalctl -u yoklama-python -f"
          echo "========================================="
